# MediaPlayer 项目结构流程图

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        MediaPlayer 主程序                       │
├─────────────────────────────────────────────────────────────────┤
│                          4个线程                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐│
│  │ readData    │ │video_thread │ │audio_thread │ │ showFrame   ││
│  │   线程      │ │    线程     │ │    线程     │ │    线程     ││
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘│
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        主线程事件循环                           │
│                    (SDL事件处理 + Seek控制)                     │
└─────────────────────────────────────────────────────────────────┘
```

## 详细数据流程图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   视频文件      │    │   Packet队列    │    │   Frame队列     │
│   (a.flv)       │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  readData线程   │───▶│ video_thread    │───▶│  showFrame线程  │
│                 │    │   解码线程      │    │   显示线程      │
│ av_read_frame() │    │ decode_packet() │    │ SDL渲染显示     │
│ packet_queue_put│    │                 │    │ 音视频同步      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       
         │              ┌─────────────────┐              
         │              │ audio_thread    │              
         └─────────────▶│   解码线程      │──────────────┐
                        │ decode_packet() │              │
                        └─────────────────┘              │
                                 │                       │
                                 ▼                       ▼
                        ┌─────────────────┐    ┌─────────────────┐
                        │   音频Frame队列 │    │  SDL音频回调    │
                        │                 │    │ audioDataRead() │
                        └─────────────────┘    │ 音频播放输出    │
                                               └─────────────────┘
```

## 线程详细功能

### 1. readData 线程 (数据读取)
```
while(!is_close) {
    ┌─ 检查seek请求 ───┐
    │  if(seek_req)    │
    │    seek()        │ ← 这里是你遇到问题的地方
    └──────────────────┘
           │
           ▼
    ┌─ 读取数据包 ─────┐
    │ av_read_frame()  │ ← 可能阻塞的地方
    │ packet_queue_put │
    └──────────────────┘
}
```

### 2. video_thread 线程 (视频解码)
```
while(true) {
    ┌─ 等待视频包 ─────┐
    │ 从vPacket_queue  │
    │ 取出AVPacket     │
    └──────────────────┘
           │
           ▼
    ┌─ 解码视频包 ─────┐
    │ decode_packet()  │
    │ 生成AVFrame      │
    │ 放入vFrame_queue │
    └──────────────────┘
}
```

### 3. audio_thread 线程 (音频解码)
```
while(true) {
    ┌─ 等待音频包 ─────┐
    │ 从aPacket_queue  │
    │ 取出AVPacket     │
    └──────────────────┘
           │
           ▼
    ┌─ 解码音频包 ──────┐
    │ decode_packet()  │
    │ 生成AVFrame      │
    │ 放入aFrame_queue │
    └──────────────────┘
}
```

### 4. showFrame 线程 (视频显示)
```
while(true) {
    ┌─ 等待视频帧 ─────┐
    │ 从vFrame_queue   │
    │ 取出AVFrame      │
    └──────────────────┘
           │
           ▼
    ┌─ 音视频同步──────┐
    │ 计算延迟时间     │
    │ SDL_Delay()      │
    └──────────────────┘
           │
           ▼
    ┌─ 渲染显示 ───────┐
    │ sws_scale()      │
    │ SDL_UpdateTexture│
    │ SDL_RenderCopy   │
    └──────────────────┘
}
```

## 队列和同步机制

```
┌─────────────────────────────────────────────────────────────────┐
│                        队列系统                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  vPacket_queue ←─── readData ───→ video_thread ───→ vFrame_queue│
│       ↑                                                ↓        │
│   video_Packet_mtx                              video_Frame_mtx │
│   video_Packet_cond                            video_Frame_cond │
│                                                        ↓        │
│                                                  showFrame      │
│                                                                 │
│  aPacket_queue ←─── readData ───→ audio_thread ───→ aFrame_queue│
│       ↑                                                ↓        │
│   audio_Packet_mtx                              audio_Frame_mtx │
│   audio_Packet_cond                            audio_Frame_cond │
│                                                        ↓        │
│                                                 audioDataRead   │
└─────────────────────────────────────────────────────────────────┘
```

## Seek 操作流程

```
用户按键 (LEFT/RIGHT/UP/DOWN)
         │
         ▼
┌─────────────────┐
│ 主线程事件循环  │
│ 计算seek位置    │
│ stream_seek()   │
│设置seek_req=true│
└─────────────────┘
         │
         ▼
┌─────────────────┐
│ readData线程    │ ← 你的问题可能在这里
│ 检测seek_req    │   av_read_frame可能阻塞
│ 调用seek()      │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│ seek()函数      │
│ av_seek_frame() │
│ 刷新所有队列    │
│ 发送flush_pkt   │
│ seek_req=false  │
└─────────────────┘
```

## 你遇到的问题分析

```
时间线: ──────────────────────────────────────────────────────────▶

正常打印: ████████████████                    ████████████████████
         "seek_fuck"                        "seek_fuck"

用户按键:              ↑
                    按下LEFT

av_read_frame:              ████████████████
                          (可能阻塞3-5秒)

seek执行:                                  ↑
                                        这时才执行seek

问题: av_read_frame阻塞导致readData循环暂停，
     无法及时响应seek请求
```
